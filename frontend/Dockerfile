FROM node:20-alpine as build 

# ...
WORKDIR /app

#  PASO 1: Copiar solo los archivos de dependencias
COPY package.json package-lock.json ./

#  PASO 2: Limpieza y reinstalaci贸n. Esto es CRTICO para los bindings musl/Alpine.
# Forzamos la instalaci贸n.
# RUN rm -rf package-lock.json node_modules
RUN npm install --legacy-peer-deps --unsafe-perm

# Copiar el c贸digo fuente (para que no interfiera con la instalaci贸n)
COPY . .

# Compilar la aplicaci贸n React/Vite
RUN npm run build

# ====================================================================
# FASE 2: SERVICIO (SERVE) - No necesita cambios
# ====================================================================
FROM nginx:alpine

# 1. Copiar el entrypoint.sh (Contiene saltos de l铆nea de Windows)
COPY entrypoint.sh /docker-entrypoint.sh

# 2.  隆FIX CRTICO! Usa sed para eliminar los caracteres \r (saltos de l铆nea de DOS)
# Esto asegura que el script se ejecute correctamente en Alpine Linux.
RUN sed -i 's/\r$//' /docker-entrypoint.sh 

# 3. Dar permisos de ejecuci贸n
RUN chmod +x /docker-entrypoint.sh 

# 4. Eliminar la configuraci贸n predeterminada de Nginx
RUN rm /etc/nginx/conf.d/default.conf

# 5. Copiar un archivo de configuraci贸n de Nginx personalizado
COPY nginx.conf /etc/nginx/conf.d/default.conf

# 6. Copiar los archivos de la aplicaci贸n compilados
COPY --from=build /app/dist /usr/share/nginx/html

EXPOSE 80

# 7. Usar el script limpio como punto de entrada
ENTRYPOINT ["/docker-entrypoint.sh"]